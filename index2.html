<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIS - H·ªá th·ªëng Gi√°m s√°t An ninh UnityVina</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0f1620; color: #e0e0e0; margin: 0; padding: 0; }
    .header {
      background: #1a2332; padding: 15px 20px; text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5); position: relative;
    }
    .header h1 { margin: 0; color: #00ff88; font-size: 28px; }
    .status { padding: 10px; font-size: 18px; font-weight: bold; }
    .online { color: #00ff88; }
    .offline { color: #ff4444; animation: pulse 2s infinite; }
    .reconnecting { color: #ffaa00; }

    .time { font-size: 16px; color: #88aaff; margin-top: 5px; }

    .container {
      max-width: 1200px; margin: 20px auto; padding: 0 20px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
    }
    .card {
      background: #1e2a3a; border-radius: 10px; padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: 1px solid #334466;
      transition: all 0.3s;
    }
    .card h3 { margin-top: 0; color: #00ddff; border-bottom: 1px solid #334466; padding-bottom: 10px; }
    .alarm {
      background: #440000 !important; border: 2px solid #ff0000;
      animation: blink 1s infinite, shake 0.5s infinite;
      transform: scale(1.02);
    }
    @keyframes blink { 50% { opacity: 0.6; } }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #334466; }
    th { background: #2a374d; }
    .value { text-align: right; font-weight: bold; }
    .danger { color: #ff4444; font-weight: bold; }
    .warning { color: #ffaa00; }
    .safe { color: #00ff88; }
    .low-battery { color: #ff6600; animation: pulse 3s infinite; }

    .log {
      max-height: 300px; overflow-y: auto; background: #111a26;
      padding: 10px; border-radius: 5px; font-size: 14px;
    }
    .log div { padding: 5px 0; border-bottom: 1px dashed #334466; }
    .log .alarm { color: #ff6666; font-weight: bold; background: rgba(255,0,0,0.1); }
    .log .system { color: #88aaff; }

    .controls {
      text-align: center; margin: 20px;
    }
    button {
      padding: 12px 24px; margin: 0 10px; background: #0066cc; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-size: 16px;
    }
    button:hover { background: #0088ff; }
    button.danger { background: #cc0000; }
    button.danger:hover { background: #ff0000; }
    button:disabled { background: #555; cursor: not-allowed; }
  </style>
</head>
<body>

  <div class="header">
    <h1>SIS - H·ªá th·ªëng Gi√°m s√°t An ninh UnityVina</h1>
    <div class="status" id="connectionStatus">ƒêang k·∫øt n·ªëi...</div>
    <div class="time" id="currentTime"></div>
  </div>

  <div class="controls">
    <button id="muteBtn">üîá T·∫Øt chu√¥ng</button>
    <button id="refreshBtn" class="danger">üîÑ L√†m m·ªõi trang</button>
  </div>

  <div class="container">
    <!-- T·ªïng quan -->
    <div class="card" id="overviewCard">
      <h3>T·ªïng quan h·ªá th·ªëng</h3>
      <p>S·ªë camera ho·∫°t ƒë·ªông: <span id="camCount">0</span>/8</p>
      <p>C·∫£nh b√°o ƒëang ho·∫°t ƒë·ªông: <span id="activeAlarms">0</span></p>
      <p>Tr·∫°ng th√°i h·ªá th·ªëng: <span id="systemStatus" class="safe">B√åNH TH∆Ø·ªúNG</span></p>
      <p>Pin thi·∫øt b·ªã: <span id="batteryStatus" class="safe">ƒêang t·∫£i...</span></p>
    </div>

    <!-- C·∫£m bi·∫øn chuy·ªÉn ƒë·ªông + m·ªü c·ª≠a + kh√≥i -->
    <div class="card" id="motionCard">
      <h3>C·∫£m bi·∫øn An ninh</h3>
      <table>
        <tr><th>V·ªã tr√≠</th><th class="value">Tr·∫°ng th√°i</th></tr>
        <tr><td>C·ª≠a ch√≠nh</td><td id="motion1" class="safe">An to√†n</td></tr>
        <tr><td>Kho h√†ng</td><td id="motion2" class="safe">An to√†n</td></tr>
        <tr><td>S√¢n sau</td><td id="motion3" class="safe">An to√†n</td></tr>
        <tr><td>C·ª≠a s·ªï t·∫ßng 2</td><td id="door1" class="safe">ƒê√≥ng</td></tr>
        <tr><td>C·∫£m bi·∫øn kh√≥i</td><td id="smoke1" class="safe">B√¨nh th∆∞·ªùng</td></tr>
        <tr><td>C·∫£nh b√°o gas</td><td id="gas1" class="safe">An to√†n</td></tr>
      </table>
    </div>

    <!-- AI Detection -->
    <div class="card">
      <h3>AI Ph√°t hi·ªán b·∫•t th∆∞·ªùng</h3>
      <table>
        <tr><th>Camera</th><th class="value">Ph√°t hi·ªán</th></tr>
        <tr><td>Cam 01 - C·ªïng</td><td id="ai1">-</td></tr>
        <tr><td>Cam 02 - Kho</td><td id="ai2">-</td></tr>
        <tr><td>Cam 03 - VƒÉn ph√≤ng</td><td id="ai3">-</td></tr>
        <tr><td>Cam 04 - S√¢n</td><td id="ai4">-</td></tr>
      </table>
    </div>

    <!-- M√¥i tr∆∞·ªùng (n·∫øu c√≥) -->
    <div class="card">
      <h3>M√¥i tr∆∞·ªùng</h3>
      <table>
        <tr><td>Nhi·ªát ƒë·ªô</td><td id="temp" class="value safe">-</td></tr>
        <tr><td>ƒê·ªô ·∫©m</td><td id="humi" class="value safe">-</td></tr>
        <tr><td>√Åp su·∫•t kh√≠ quy·ªÉn</td><td id="pressure" class="value">-</td></tr>
      </table>
    </div>

    <!-- Nh·∫≠t k√Ω -->
    <div class="card">
      <h3>Nh·∫≠t k√Ω s·ª± ki·ªán (Realtime)</h3>
      <div class="log" id="eventLog">
        <div class="system">‚Üí H·ªá th·ªëng ƒëang kh·ªüi ƒë·ªông...</div>
      </div>
    </div>
  </div>

<script>
// === C·∫§U H√åNH FIREBASE ===
const firebaseConfig = {
  databaseURL: "https://unityvina-1fc51-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Bi·∫øn to√†n c·ª•c
let isMuted = false;
let alarmAudio = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_9033d9f97a.mp3?filename=alarm-siren-6045.mp3&g_recaptcha_token=&g_recaptcha_token=&g_recaptcha_token='); // √¢m thanh c·∫£nh b√°o
alarmAudio.loop = true;

let offlineStartTime = null;
let reconnectAttempts = 0;

// C·∫≠p nh·∫≠t ƒë·ªìng h·ªì realtime
function updateClock() {
  const now = new Date();
  document.getElementById("currentTime").textContent = 
    now.toLocaleDateString('vi-VN') + " " + now.toLocaleTimeString('vi-VN');
}
setInterval(updateClock, 1000);
updateClock();

// Ki·ªÉm tra k·∫øt n·ªëi Firebase
const connectedRef = db.ref(".info/connected");
connectedRef.on("value", (snap) => {
  const statusEl = document.getElementById("connectionStatus");
  if (snap.val() === true) {
    statusEl.textContent = "ONLINE - ƒê√£ k·∫øt n·ªëi";
    statusEl.className = "status online";
    reconnectAttempts = 0;
    if (offlineStartTime) {
      const offlineDuration = Math.round((Date.now() - offlineStartTime) / 1000);
      addLog(`ƒê√£ kh√¥i ph·ª•c k·∫øt n·ªëi sau ${offlineDuration} gi√¢y m·∫•t k·∫øt n·ªëi`, "system");
      offlineStartTime = null;
    }
  } else {
    statusEl.textContent = "OFFLINE - ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...";
    statusEl.className = "status reconnecting";
    if (!offlineStartTime) offlineStartTime = Date.now();
    reconnectAttempts++;
    if (reconnectAttempts > 10) {
      addLog(`M·∫•t k·∫øt n·ªëi qu√° l√¢u (>60s) - T·ª± ƒë·ªông l√†m m·ªõi trang...`, "system");
      setTimeout(() => location.reload(), 3000);
    }
  }
});

// Tham chi·∫øu d·ªØ li·ªáu
const alarmsRef = db.ref("alarms");
const sensorsRef = db.ref("sensors");
const aiRef = db.ref("ai_detection");
const envRef = db.ref("environment");
const deviceRef = db.ref("device_status");
const logsRef = db.ref("logs");

let activeAlarmCount = 0;

// T·∫Øt/M·ªü chu√¥ng
document.getElementById("muteBtn").addEventListener("click", () => {
  isMuted = !isMuted;
  document.getElementById("muteBtn").textContent = isMuted ? "üîä B·∫≠t chu√¥ng" : "üîá T·∫Øt chu√¥ng";
  if (isMuted) alarmAudio.pause();
});

// L√†m m·ªõi trang
document.getElementById("refreshBtn").addEventListener("click", () => location.reload());

// Ph√°t √¢m thanh + rung th·∫ª
function triggerAlarm() {
  if (!isMuted) {
    alarmAudio.play().catch(() => {});
  }
  document.querySelectorAll(".card").forEach(card => {
    card.classList.add("alarm");
    setTimeout(() => card.classList.remove("alarm"), 3000);
  });
}

// Th√™m log
function addLog(message, type = "") {
  const logEl = document.getElementById("eventLog");
  const now = new Date().toLocaleTimeString();
  const div = document.createElement("div");
  div.innerHTML = `<strong>[${now}]</strong> ${message}`;
  if (type) div.className = type;
  logEl.appendChild(div);
  logEl.scrollTop = logEl.scrollHeight;
}

// === C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU T·ª™ ƒê·∫¶U ===
window.addEventListener("load", () => {
  addLog("H·ªá th·ªëng SIS ƒëang t·∫£i to√†n b·ªô d·ªØ li·ªáu t·ª´ Firebase...", "system");

  // C·∫£m bi·∫øn chuy·ªÉn ƒë·ªông + c·ª≠a + kh√≥i + gas
  sensorsRef.once("value").then(snapshot => {
    const data = snapshot.val() || {};
    Object.keys(data).forEach((key, idx) => {
      const value = data[key];
      let el, text, cls;
      if (key.includes("motion")) {
        el = document.getElementById("motion" + (idx + 1));
        text = value ? "PH√ÅT HI·ªÜN CHUY·ªÇN ƒê·ªòNG!" : "An to√†n";
        cls = value ? "danger" : "safe";
      } else if (key.includes("door")) {
        el = document.getElementById("door1");
        text = value ? "ƒêANG M·ªû!" : "ƒê√≥ng";
        cls = value ? "danger" : "safe";
      } else if (key.includes("smoke")) {
        el = document.getElementById("smoke1");
        text = value ? "PH√ÅT HI·ªÜN KH√ìI!" : "B√¨nh th∆∞·ªùng";
        cls = value ? "danger" : "safe";
      } else if (key.includes("gas")) {
        el = document.getElementById("gas1");
        text = value ? "R√í R·ªà GAS!" : "An to√†n";
        cls = value ? "danger" : "safe";
      }
      if (el) {
        el.textContent = text;
        el.className = cls;
        if (value) triggerAlarm();
      }
    });
  });

  // AI Detection
  aiRef.once("value").then(snapshot => {
    const data = snapshot.val() || {};
    Object.keys(data).forEach((key, idx) => {
      const item = data[key];
      if (item && item.threat && item.threat !== "B√¨nh th∆∞·ªùng") {
        const el = document.getElementById("ai" + (idx + 1));
        if (el) {
          el.textContent = item.threat;
          el.className = "danger";
          triggerAlarm();
        }
      }
    });
  });

  // M√¥i tr∆∞·ªùng
  envRef.once("value").then(snapshot => {
    const e = snapshot.val();
    if (e) {
      document.getElementById("temp").textContent = e.temperature + "¬∞C";
      document.getElementById("humi").textContent = e.humidity + "%";
      document.getElementById("pressure").textContent = e.pressure + " hPa";

      if (e.temperature > 50) {
        document.getElementById("temp").className = "value danger";
        addLog(`C·∫¢NH B√ÅO NHI·ªÜT ƒê·ªò CAO: ${e.temperature}¬∞C`, "alarm");
        triggerAlarm();
      }
    }
  });

  // Pin thi·∫øt b·ªã
  deviceRef.child("battery").on("value", snap => {
    const battery = snap.val();
    const el = document.getElementById("batteryStatus");
    if (battery !== null) {
      el.textContent = battery + "%";
      if (battery < 20) {
        el.className = "low-battery";
        addLog(`PIN Y·∫æU: Ch·ªâ c√≤n ${battery}% - Vui l√≤ng s·∫°c ngay!`, "alarm");
      } else {
        el.className = "safe";
      }
    }
  });
});

// Theo d√µi realtime (sau khi t·∫£i ban ƒë·∫ßu)
sensorsRef.on("child_changed", (snap) => {
  const key = snap.key;
  const value = snap.val();
  // Logic gi·ªëng ph·∫ßn load ban ƒë·∫ßu, nh∆∞ng ch·ªâ c·∫≠p nh·∫≠t thay ƒë·ªïi
  // (ƒë√£ x·ª≠ l√Ω ·ªü tr√™n b·∫±ng .once, gi·ªù ch·ªâ c·∫ßn c·∫£nh b√°o)
  if (value === true || value === 1) {
    addLog(`C·∫¢NH B√ÅO: ${key.toUpperCase().replace("_", " ")} b·ªã k√≠ch ho·∫°t!`, "alarm");
    triggerAlarm();
  }
});

addLog("H·ªá th·ªëng SIS ƒë√£ k·∫øt n·ªëi th√†nh c√¥ng & t·∫£i d·ªØ li·ªáu xong!", "system");
</script>

</body>
</html>